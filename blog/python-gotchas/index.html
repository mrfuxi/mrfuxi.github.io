<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Python gotchas - Coding After Hours
</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Karol Dulęba">

    <meta name="keywords" content="Python, Solr, C++, Linux, Docker, Lucene, Django, blog, software development">
    <meta name="description" content="Blog about writing software with Python, Solr and the processes around">

            <link href="http://mrfuxi.github.io/theme/css/bootstrap.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/style.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/custom.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/responsive.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/fonts/font-awesome.min.css" />

    <link href="http://mrfuxi.github.io/theme/css/highlightjs/default.min.css" rel="stylesheet">

    <link href="http://mrfuxi.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Coding After Hours Atom Feed" />


    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>
  <body class="col-1cl full-width topbar-enabled"
>
<header id="header">
    <nav class="nav-container group" id="nav-topbar">
        <div class="nav-toggle"><i class="fa fa-bars"></i></div>
        <div class="nav-text"><!-- put your mobile menu text here --></div>

        <div class="nav-wrap container">
<ul id="menu-topbar-menu" class="nav container-inner group">
    <li class="menu-item">
        <a href="/">
            Home
        </a>
    </li>

        <li class="menu-item current_page_item ">
            <a href="http://mrfuxi.github.io/blog/">
                blog
            </a>
        </li>

        <li class="menu-item ">
            <a href="http://mrfuxi.github.io/pages/projects/">
                Projects
            </a>
        </li>
        <li class="menu-item ">
            <a href="http://mrfuxi.github.io/pages/contact/">
                Contact
            </a>
        </li>
        <li class="menu-item ">
            <a href="http://mrfuxi.github.io/pages/about/">
                About
            </a>
        </li>
</ul>
        </div>

    </nav>

    <div class="container">
        <div class="pad group">
            <h1 class="site-title">
                <a href="/" rel="home">
                    <img src="http://mrfuxi.github.io/theme/img/logo.png" alt="Coding After Hours">
                </a>
            </h1>
            <p class="site-description">Coding After Hours</p>

            <ul class="social-links">
                <li>
                    <a rel="nofollow" class="social-tooltip" title="Twitter" href="https://twitter.com/MrFuxi">
                        <i class="fa fa-twitter"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="GitHub" href="https://github.com/mrfuxi">
                        <i class="fa fa-github"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="Google Plus" href="https://plus.google.com/+KarolDulęba">
                        <i class="fa fa-google-plus"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="LinkedIn" href="http://www.linkedin.com/in/dulebakarol">
                        <i class="fa fa-linkedin"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div><!--/.container-->
</header>

    <div id="page" class="container ">
        <div class="main group">
            <section class="content">
    <div class="pad group">         

<article class="post-2315 post type-post status-publish hentry category-post-formats group format-post">
    <h2 class="post-title pad">
        Python gotchas
    </h2>

    <ul class="post-meta pad group">
        <li><a href="http://mrfuxi.github.io/blog/" title="View all posts in blog" rel="category tag">blog</a></li>
        <li><i class="fa fa-clock-o"></i>2014-06-16</li>
        <li><a class="fa fa-comment" href="http://mrfuxi.github.io/blog/python-gotchas/#disqus_thread" data-disqus-identifier="2014-06-16-python-gotchas"></a></li>
    </ul>


    <div class="post-inner">
        <div class="post-deco">
            <div class="hex hex-small">
                <div class="hex-inner"><i class="fa"></i></div>
                <a href="http://mrfuxi.github.io/type/post/"></a>
                <div class="corner-1"></div>
                <div class="corner-2"></div>
            </div>
        </div>

        <div class="post-content pad">
                <div class="entry">
                    <p>There are times in life of every Python developer, when you are staring at the screen and can not explain or even understand what just happened.</p>
<p>I would like to show couple of Python gotchas, that should a bring smile onto your face. At least that's the effect they have on me.</p>
<h2>Identity of an int</h2>
<p>Imagine scenario when you're comparing identities of 2 objects, ints in this case (do not confuse with comparing values).</p>
<pre><code class="python">&gt;&gt;&gt; list_a = [-6, -5, -1, 0, 1, 10, 256, 257, 999]
&gt;&gt;&gt; list_b = [-6, -5, -1, 0, 1, 10, 256, 257, 999]
&gt;&gt;&gt; for a, b in zip(list_a, list_b):
...     print &quot;{:3} is {:3} -&gt; {}&quot;.format(a, b, a is b)

 -6 is  -6 -&gt; False
 -5 is  -5 -&gt; True
 -1 is  -1 -&gt; True
  0 is   0 -&gt; True
  1 is   1 -&gt; True
 10 is  10 -&gt; True
256 is 256 -&gt; True
257 is 257 -&gt; False
999 is 999 -&gt; False
</code></pre>

<p>You might expect to get Falses for all of comparisons, as new int object should get a new address and <code>is</code> operator compares addresses. If you did not know that or you don't believe try running that:</p>
<pre><code class="python">&gt;&gt;&gt; x = 999
&gt;&gt;&gt; hex(id(x))
'0x18f5948'
&gt;&gt;&gt; y = 999
&gt;&gt;&gt; hex(id(y))
'0x18f59d8'
</code></pre>

<p>Ok, but how can operator behave differently for some ints, that does not make sense!
Actually it does... Numbers between -5 and 256 (inclusive) are special to Python (optimization).
You can look up source code (written in C), it's located in <code>Objects/intobject.c</code> (Python 2.x) or in <code>Objects/longobject.c</code> (Python 3.x).</p>
<pre><code>#ifndef NSMALLPOSINTS
#define NSMALLPOSINTS           257
#endif
#ifndef NSMALLNEGINTS
#define NSMALLNEGINTS           5
#endif
#if NSMALLNEGINTS + NSMALLPOSINTS &gt; 0
/* References to small integers are saved in this array so that they
   can be shared.
   The integers that are saved are those in the range
   -NSMALLNEGINTS (inclusive) to NSMALLPOSINTS (not inclusive).
*/
static PyIntObject *small_ints[NSMALLNEGINTS + NSMALLPOSINTS];
#endif
</code></pre>

<p>Array is then filled in by <code>_PyInt_Init</code>.</p>
<p>Interesting thing is that those both boundaries where last time changed in Python 2.5 (from 99 to 256). Lower boundary was moved (from -1 to -5) in Python 2.3.</p>
<p>If someone is interested in reasoning, please look up both bug tickets <a href="http://bugs.python.org/issue1436243">99 -&gt; 256</a> and <a href="http://bugs.python.org/issue561244">-1 -&gt; -5</a>.</p>
<p>In my opinion that was worth pointing out, because it shows that Python is actually a living organism that is evolving. Secondly you need to remember that Python is just a piece of software and code behind it (including bugs) specifies it behaviour. That is very important, as behaviour presented above is <strong>not</strong> true for PyPy.</p>
<h2>Identity of a string</h2>
<p>So you know that when creating new string object you're getting new immutable object. That could lead to conclusion, that every string in Python has is unique as it has it's own memory allocation. Code below would suggest so too:</p>
<pre><code class="python">&gt;&gt;&gt; y = 'a-b-c'
&gt;&gt;&gt; x = 'a-b-c'
&gt;&gt;&gt; x is y
False
&gt;&gt;&gt; y = 'a b c'
&gt;&gt;&gt; x = 'a b c'
&gt;&gt;&gt; x is y
False
</code></pre>

<p>But what about that:</p>
<pre><code class="python">&gt;&gt;&gt; y = 'abc'
&gt;&gt;&gt; x = 'abc'
&gt;&gt;&gt; x is y
True
&gt;&gt;&gt; y = 'a_b_c'
&gt;&gt;&gt; x = 'a_b_c'
&gt;&gt;&gt; x is y
True
</code></pre>

<p>If you would run code from first example Python will allocate 4 different objects in memory (as suspected). However in the second example Python will allocate only 2 objects! One for each 'abc' and 'a_b_c'. Why is that?</p>
<p>It's another Python optimization. Quoting source code:</p>
<blockquote>
<p>Caching the hash (ob_shash) saves recalculation of a string's hash value.
Interning strings (ob_sstate) tries to ensure that only one string
object with a given value exists, so equality tests can be one pointer
comparison.  This is generally restricted to strings that "look like"
Python identifiers, although the intern() builtin can be used to force
interning of any string.
Together, these sped the interpreter by up to 20%.</p>
<p>-- <cite>Python 2.7 - <code>Include/stringobject.h</code></cite></p>
</blockquote>
<p>If you're interested in some parts of implementations, look up <code>PyString_InternInPlace</code> in <code>Objects/stringobject.c</code>.</p>
<p>On top of that <strong>all</strong> strings with length 0 or 1 are also singletons.</p>
<p>While regular strings (length of 2 or more) are stored in <code>interned</code> dict. Strings that contain single character are stored in <code>characters</code> array. Finally all empty strings are stored as <code>nullstring</code> object.</p>
<p>That pattern is specified as <a href="http://en.wikipedia.org/wiki/String_interning">String interning</a>.</p>
<p>Again this behaviour is specific to the implementation, and it's not present in PyPy.</p>
<h2>Fun with generators</h2>
<p>This one is not a "gotcha", but well known behaviour, or at least is should be. However it can take you by surprise.</p>
<p>From time to time you need to generate number of SQL based on some attributes. Basically it's the same query with different table name or value in one of clauses.</p>
<pre><code class="python">&gt;&gt;&gt; TABLES_TO_TRUNCATE = ['t1', 't2', 't3']
&gt;&gt;&gt; query = &quot;TRUNCATE TABLE {};&quot;
&gt;&gt;&gt; queries = [query.format(table) for table in TABLES_TO_TRUNCATE]
&gt;&gt;&gt; for query in queries:
...     print query
...     execute(query)

TRUNCATE TABLE t1;
TRUNCATE TABLE t2;
TRUNCATE TABLE t3;
</code></pre>

<p>This code will happily truncate all specified tables (<code>execute</code> would be helper method that actually do the work).
At this point you are happy and ready to move on. Then someone suggests to use a generator instead of list comprehension. That is very small change and actually... why not.
Just to make sure you're re-running your code to check is everything fine. You might be surprised when it's not working. Take a look at the state after suggested change:</p>
<pre><code class="python">&gt;&gt;&gt; TABLES_TO_TRUNCATE = ['t1', 't2', 't3']
&gt;&gt;&gt; query = &quot;TRUNCATE TABLE {};&quot;
&gt;&gt;&gt; queries = (query.format(table) for table in TABLES_TO_TRUNCATE)
&gt;&gt;&gt; for query in queries:
...     print query
...     execute(query)

TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
TRUNCATE TABLE t1;
</code></pre>

<p>Do you know why that happened and how to fix it (without going back to list comprehension)?</p>
<p>Answer is very simple. Because generators are evaluated lazily, when next value is needed, <code>query</code> string that contains place holder used by format is replaced after first iteration with already formatted string!
<code>query</code> variable should not be reused.</p>
<p>With list comprehension everything works as expected, because it's evaluated immediately.</p>
<p>Happy coding :D</p>
                </div>

    <div class="blogItem">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'mrfuxi';

        var disqus_identifier = '2014-06-16-python-gotchas';


        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
             document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
        Please enable JavaScript to view the
        <a href="http://disqus.com/?ref_noscript=mrfuxi">
            comments powered by Disqus.
        </a>
    </noscript>
    <a href="http://disqus.com" class="dsq-brlink">
        blog comments powered by <span class="logo-disqus">Disqus</span>
    </a>
    </div>
        </div>
    </div>
</article>    </div>
            </section>
            <div class="sidebar s1">
            </div>
        </div>
    </div>

    <script src="http://mrfuxi.github.io/theme/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-51123213-1', 'auto');
    ga('send', 'pageview');
</script>
<script type="text/javascript">
    var disqus_shortname = 'mrfuxi';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

<footer id="footer">
    <section id="footer-bottom">
        <div class="container">
            <a id="back-to-top" href="#">
                <i class="fa fa-angle-up"></i>
            </a>
            <div class="pad group">
                <div class="grid one-half">
                    <img id="footer-logo" src="http://mrfuxi.github.io/theme/img/footer_logo.png" alt="Coding After Hours">
                    <div id="copyright">
                        <p>
                            Coding After Hours &copy; 2014. All Rights Reserved.
                        </p>
                    </div>

                    <div id="credit">
                        <p>
                            Proudly powered by <a href="http://getpelican.com/" rel="nofollow">Pelican</a>, which takes great advantage of <a href="http://python.org" rel="nofollow">Python</a>.
                            Theme by <a href="http://alxmedia.se" rel="nofollow">Alx</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</footer>
  </body>
</html>