<!DOCTYPE html>
<html lang="en">
  <head>
    <title></title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link href="http://mrfuxi.github.io/theme/css/bootstrap.css" rel="stylesheet" media="screen">
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/style.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/custom.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/responsive.css" />
        <link rel="stylesheet" href="http://mrfuxi.github.io/theme/fonts/font-awesome.min.css" />

    <link href="http://mrfuxi.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Coding After Hours Atom Feed" />


    <!--[if IE]>
        <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  </head>
  <body class="col-1cl full-width topbar-enabled"
>
<header id="header">
    <nav class="nav-container group" id="nav-topbar">
        <div class="nav-toggle"><i class="fa fa-bars"></i></div>
        <div class="nav-text"><!-- put your mobile menu text here --></div>

        <div class="nav-wrap container">
<ul id="menu-topbar-menu" class="nav container-inner group">
    <li class="menu-item">
        <a href="/">
            Home
        </a>
    </li>

        <li class="menu-item current_page_item ">
            <a href="http://mrfuxi.github.io/blog/">
                blog
            </a>
        </li>

</ul>
        </div>

    </nav>

    <div class="container">
        <div class="pad group">
            <h1 class="site-title">
                <a href="/" rel="home">
                    <img src="http://mrfuxi.github.io/theme/img/logo.png" alt="Coding After Hours">
                </a>
            </h1>
            <p class="site-description">Coding After Hours</p>

            <ul class="social-links">
                <li>
                    <a rel="nofollow" class="social-tooltip" title="Twitter" href="https://twitter.com/MrFuxi">
                        <i class="fa fa-twitter"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="GitHub" href="https://github.com/mrfuxi">
                        <i class="fa fa-github"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="Google Plus" href="https://plus.google.com/+KarolDulÄ™ba">
                        <i class="fa fa-google-plus"></i>
                    </a>
                </li>
                <li>
                    <a rel="nofollow" class="social-tooltip" title="LinkedIn" href="http://www.linkedin.com/in/dulebakarol">
                        <i class="fa fa-linkedin"></i>
                    </a>
                </li>
            </ul>
        </div>
    </div><!--/.container-->
</header>

    <div id="page" class="container ">
        <div class="main group">
            <section class="content">
    <div class="pad group">         

<article class="post-2315 post type-post status-publish hentry category-post-formats group format-post">
    <h2 class="post-title pad">
        Use Docker to develop Solr plugin
    </h2>

    <ul class="post-meta pad group">
        <li><a href="http://mrfuxi.github.io/blog/" title="View all posts in blog" rel="category tag">blog</a></li>
        <li><i class="fa fa-clock-o"></i>2014-05-05</li>
        <li><a href="http://mrfuxi.github.io/blog/use-docker-to-develop-solr-plugin/#comments"><i class="fa fa-comment"></i></a></li>
    </ul>


    <div class="post-inner">
        <div class="post-deco">
            <div class="hex hex-small">
                <div class="hex-inner"><i class="fa"></i></div>
                <a href="http://mrfuxi.github.io/type/post/"></a>
                <div class="corner-1"></div>
                <div class="corner-2"></div>
            </div>
        </div>

        <div class="post-content pad">
                <div class="entry">
                    <p>From time to time I have a need to customize Solr a bit more that is's possible using regular configuration.</p>
<p>I those times I tend to create a plug-ins (<a href="https://github.com/mrfuxi/UniqueCounter">UniqueCounter</a>, <a href="https://github.com/mrfuxi/TokenMatcher">TokenMatcher</a>).</p>
<p>Previously I was using Eclipse, as it was able to run Solr using Jetty. It had obvious advantage of running Solr for me, so I can test my code quickly. On the other side it's a hassle to set up correctly, changing version of Solr is also not easy.</p>
<p>I realized that I need to have a repeatable environment that I can simply dump when plug-in is done and restore if I want to fix/change something. If that would be Python I would just use good old tandem of virtualenv and requirements.txt.</p>
<p>For this occasion I choose <a href="https://www.docker.io/">Docker</a>. That way I can define how env has to be created and the only thing I have to keep this definition. You can say that it would be quite a hassle to define all from scratch (install Java, Solr and so on). You might be right, if it would not be for the Docker community! There are number of containers to choose from and to modify. I used <a href="https://index.docker.io/u/makuk66/docker-solr/">makuk66/docker-solr</a> as a base (description including version of Solr on side is a bit out of date comparing to <a href="https://github.com/makuk66/docker-solr/blob/master/Dockerfile">Git repo</a>).</p>
<p>That container gives installed Solr in version to play and needs some extra work in order to use it for development. So I extended it by:</p>
<ul>
<li>extracting jars to known location (<em>/opt/solr_jars</em>)</li>
<li>allowing to mount plug-in code (to: <em>/opt/code</em>)</li>
<li>allowing to mount core configuration (to: <em>/opt/cores</em>)</li>
</ul>
<p>By default when running container you'll get bash in location of your code.
That way environment part is done. Remaining thing is to be able to compile and run Solr with a plug-in. To do that I created rather simple <em>build.xml</em>.</p>
<p>At the end of the day I can start new container, build plug-in and run Solr in couple of lines:</p>
<div class="highlight"><pre><span class="cp"># Build image (1 off)</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">solr_dev</span> <span class="p">.</span>

<span class="cp"># Start new container</span>
<span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">i</span> <span class="o">--</span><span class="n">rm</span> <span class="o">-</span><span class="n">t</span> <span class="o">-</span><span class="n">v</span> <span class="err">`</span><span class="n">pwd</span><span class="err">`</span><span class="o">/</span><span class="n">plugin</span><span class="o">:/</span><span class="n">opt</span><span class="o">/</span><span class="n">code</span><span class="o">:</span><span class="n">rw</span> <span class="o">-</span><span class="n">P</span> <span class="o">-</span><span class="n">v</span> <span class="err">`</span><span class="n">pwd</span><span class="err">`</span><span class="o">/</span><span class="n">cores</span><span class="o">:/</span><span class="n">opt</span><span class="o">/</span><span class="n">cores</span><span class="o">/:</span><span class="n">r</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8983</span><span class="o">:</span><span class="mi">8983</span> <span class="n">solr_dev</span>

<span class="cp"># Recompile plug-in and start Solr</span>
<span class="n">ant</span> <span class="n">run</span>
</pre></div>


<hr />
<p>Below you'll find full definitions of both Docker image and Java build file.</p>
<p>Dockerfile:</p>
<div class="highlight"><pre><span class="n">FROM</span> <span class="n">makuk66</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">solr</span>
<span class="n">MAINTAINER</span>  <span class="n">Karol</span> <span class="n">Duleba</span> <span class="s">&quot;mr.fuxi@gmail.com&quot;</span>

<span class="cp"># Dev tools</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">ant</span>

<span class="cp"># Solr</span>
<span class="n">ENV</span> <span class="n">SOLR_JARS</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">solr_jars</span>

<span class="n">RUN</span> <span class="n">rm</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="err">$</span><span class="n">SOLR</span><span class="p">.</span><span class="n">tgz</span>
<span class="n">RUN</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">unzip</span>
<span class="n">RUN</span> <span class="n">unzip</span> <span class="o">-</span><span class="n">q</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">solr</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span><span class="err">$</span><span class="n">SOLR</span><span class="p">.</span><span class="n">war</span> <span class="s">&quot;*.jar&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">war</span>
<span class="n">RUN</span> <span class="n">mkdir</span> <span class="err">$</span><span class="n">SOLR_JARS</span>
<span class="n">RUN</span> <span class="n">mv</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">war</span><span class="o">/</span><span class="n">WEB</span><span class="o">-</span><span class="n">INF</span><span class="o">/</span><span class="n">lib</span><span class="o">/*</span><span class="p">.</span><span class="n">jar</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">solr_jars</span>
<span class="n">RUN</span> <span class="n">cp</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">solr</span><span class="o">/</span><span class="n">dist</span><span class="o">/</span><span class="n">solrj</span><span class="o">-</span><span class="n">lib</span><span class="o">/*</span><span class="n">slf4j</span><span class="o">*</span><span class="p">.</span><span class="n">jar</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">solr_jars</span>

<span class="n">VOLUME</span> <span class="p">[</span><span class="s">&quot;/opt/code&quot;</span><span class="p">,</span> <span class="s">&quot;/opt/cores&quot;</span><span class="p">]</span>
<span class="n">WORKDIR</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">code</span>

<span class="n">EXPOSE</span> <span class="mi">8983</span>

<span class="n">CMD</span> <span class="p">[</span><span class="s">&quot;/bin/bash&quot;</span><span class="p">]</span>
</pre></div>


<p>build.xml:</p>
<div class="highlight"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span> <span class="n">standalone</span><span class="o">=</span><span class="s">&quot;no&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">project</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;SolrPlugin&quot;</span> <span class="n">basedir</span><span class="o">=</span><span class="s">&quot;.&quot;</span> <span class="k">default</span><span class="o">=</span><span class="s">&quot;main&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;src.dir&quot;</span>     <span class="n">value</span><span class="o">=</span><span class="s">&quot;src&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;build.dir&quot;</span>   <span class="n">value</span><span class="o">=</span><span class="s">&quot;bin&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;classes.dir&quot;</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;${build.dir}/classes&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;jar.dir&quot;</span>     <span class="n">value</span><span class="o">=</span><span class="s">&quot;${build.dir}/jar&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;lib.dir&quot;</span>     <span class="n">value</span><span class="o">=</span><span class="s">&quot;../solr_jars&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">property</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;jar.name&quot;</span>    <span class="n">value</span><span class="o">=</span><span class="s">&quot;awasome-plugin&quot;</span><span class="o">/&gt;</span>

    <span class="o">&lt;</span><span class="n">path</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;classpath&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">fileset</span> <span class="n">dir</span><span class="o">=</span><span class="s">&quot;${lib.dir}&quot;</span> <span class="n">includes</span><span class="o">=</span><span class="s">&quot;**/*.jar&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">path</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;clean&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">delete</span> <span class="n">dir</span><span class="o">=</span><span class="s">&quot;${build.dir}&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;compile&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">mkdir</span> <span class="n">dir</span><span class="o">=</span><span class="s">&quot;${classes.dir}&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">javac</span> <span class="n">srcdir</span><span class="o">=</span><span class="s">&quot;${src.dir}&quot;</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&quot;${classes.dir}&quot;</span> <span class="n">classpathref</span><span class="o">=</span><span class="s">&quot;classpath&quot;</span> <span class="n">includeantruntime</span><span class="o">=</span><span class="s">&quot;false&quot;</span> <span class="n">debug</span><span class="o">=</span><span class="s">&quot;on&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;lint&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">javac</span> <span class="n">srcdir</span><span class="o">=</span><span class="s">&quot;${src.dir}&quot;</span> <span class="n">destdir</span><span class="o">=</span><span class="s">&quot;${classes.dir}&quot;</span> <span class="n">classpathref</span><span class="o">=</span><span class="s">&quot;classpath&quot;</span> <span class="n">includeantruntime</span><span class="o">=</span><span class="s">&quot;false&quot;</span> <span class="n">debug</span><span class="o">=</span><span class="s">&quot;on&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">compilerarg</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;-Xlint&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">javac</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;jar&quot;</span> <span class="n">depends</span><span class="o">=</span><span class="s">&quot;compile&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">mkdir</span> <span class="n">dir</span><span class="o">=</span><span class="s">&quot;${jar.dir}&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">jar</span> <span class="n">destfile</span><span class="o">=</span><span class="s">&quot;${jar.dir}/${jar.name}.jar&quot;</span> <span class="n">basedir</span><span class="o">=</span><span class="s">&quot;${classes.dir}&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;run&quot;</span> <span class="n">depends</span><span class="o">=</span><span class="s">&quot;jar&quot;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">java</span> <span class="n">jar</span><span class="o">=</span><span class="s">&quot;/opt/solr/example/start.jar&quot;</span> <span class="n">fork</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="n">dir</span><span class="o">=</span><span class="s">&quot;/opt/solr/example/&quot;</span><span class="o">&gt;</span>
            <span class="o">&lt;</span><span class="n">jvmarg</span> <span class="n">value</span><span class="o">=</span><span class="s">&quot;-Dsolr.solr.home=/opt/cores&quot;</span><span class="o">/&gt;</span>
        <span class="o">&lt;/</span><span class="n">java</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">target</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;clean-build&quot;</span> <span class="n">depends</span><span class="o">=</span><span class="s">&quot;clean,jar&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;</span><span class="n">target</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;main&quot;</span> <span class="n">depends</span><span class="o">=</span><span class="s">&quot;clean,jar&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">project</span><span class="o">&gt;</span>
</pre></div>
                </div>
        </div>
    </div>
</article>    </div>
            </section>
            <div class="sidebar s1">
            </div>
        </div>
    </div>

        <script src="http://mrfuxi.github.io/theme/js/jquery-1.11.0.js"></script>
        <script src="http://mrfuxi.github.io/theme/js/bootstrap.js"></script>
        <script src="http://mrfuxi.github.io/theme/js/scripts.js"></script>
        <script src="http://mrfuxi.github.io/theme/js/jquery.flexslider.min.js"></script>


<footer id="footer">
    <section id="footer-bottom">
        <div class="container">
            <a id="back-to-top" href="#">
                <i class="fa fa-angle-up"></i>
            </a>
            <div class="pad group">
                <div class="grid one-half">
                    <img id="footer-logo" src="http://mrfuxi.github.io/theme/img/footer_logo.png" alt="Coding After Hours">
                    <div id="copyright">
                        <p>
                            Coding After Hours &copy; 2014. All Rights Reserved.
                        </p>
                    </div>

                    <div id="credit">
                        <p>
                            Proudly powered by <a href="http://getpelican.com/" rel="nofollow">Pelican</a>, which takes great advantage of <a href="http://python.org" rel="nofollow">Python</a>.
                            Theme by <a href="http://alxmedia.se" rel="nofollow">Alx</a>.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
</footer>
  </body>
</html>